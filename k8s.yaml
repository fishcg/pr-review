apiVersion: apps/v1
kind: Deployment
metadata:
  name: pr-review-service
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: pr-review
  template:
    metadata:
      labels:
        app: pr-review
    spec:
      containers:
        - name: server
          image: 172.24.173.77:30500/pr-review:0.0.1
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 7995
          volumeMounts:
            - name: config
              mountPath: /app/config.yaml
              subPath: config.yaml
          resources:
            requests: # è¿™ç§æœåŠ¡éå¸¸çœèµ„æº
              memory: "20Mi"
              cpu: "10m"
            limits:
              memory: "40Mi"
              cpu: "20m"
      volumes:
        - name: config
          configMap:
            name: pr-review-config
---
apiVersion: v1
kind: Service
metadata:
  name: pr-review-service
  namespace: default
spec:
  type: NodePort
  selector:
    app: pr-review
  ports:
    - protocol: TCP
      port: 7995
      targetPort: 7995
      nodePort: 30095
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: pr-review-config
  namespace: default
data:
  config.yaml: |
    # PR Review Service Configuration

    # AI Service URL (required)
    ai_api_url: "http://ai-info-service:3128/chat/completions"

    # AI API Key (required for AI service authentication)
    ai_api_key: "test-api-key"

    # AI Model name (default: qwen-plus-latest)
    ai_model: "qwen-max-latest"

    # Service port (default: 7995)
    port: "7995"

    # GitHub Personal Access Token (required for API access)
    # Needs permissions: repo (for private repos) or public_repo (for public repos)
    github_token: "test-github-token"

    # AI Review Prompts
    # System prompt - defines the AI's role and behavior
    system_prompt: |
      ä½ æ˜¯ä¸€ä¸ªèµ„æ·±çš„ä»£ç å®¡æŸ¥ä¸“å®¶ï¼Œæ‹¥æœ‰ 10 å¹´ä»¥ä¸Šçš„è½¯ä»¶å¼€å‘ç»éªŒã€‚
      ä½ æ“…é•¿å‘ç°ä»£ç ä¸­çš„é—®é¢˜ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºï¼šBugã€å®‰å…¨æ¼æ´ã€æ€§èƒ½é—®é¢˜ã€ä»£ç è§„èŒƒã€æœ€ä½³å®è·µç­‰ã€‚
      è¯·å§‹ç»ˆä¿æŒä¸“ä¸šã€å®¢è§‚ã€å»ºè®¾æ€§çš„æ€åº¦ï¼Œç”¨ä¸­æ–‡å›å¤ï¼Œä½¿ç”¨ Markdown æ ¼å¼ã€‚

    # User prompt template - the actual review request
    # Use {diff} as placeholder for the code diff
    user_prompt_template: |
      è¯·å¯¹ä»¥ä¸‹ Pull Request çš„ä»£ç å˜æ›´è¿›è¡Œå…¨é¢å®¡æŸ¥ï¼Œå¹¶æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼š

      ## ğŸ“Š ä»£ç è´¨é‡è¯„åˆ†
      **æ€»åˆ†: 95**  ï¼ˆæ»¡åˆ† 100 åˆ†ï¼Œå¦‚æœæœ‰ä¸¥é‡ bug åˆ™ä½äº 60ï¼Œå¦‚æœæœ‰è¯­æ³•é”™è¯¯ä¸º 0 åˆ†ï¼Œlint é—®é¢˜æœ€å¤šæ‰£ 5åˆ°10 åˆ†ï¼‰

      ## ğŸ” å®¡æŸ¥è¦ç‚¹

      ### âœ… åšå¾—å¥½çš„åœ°æ–¹
      - ï¼ˆåˆ—å‡ºä»£ç ä¸­å€¼å¾—è‚¯å®šçš„éƒ¨åˆ†ï¼‰

      ### âš ï¸ éœ€è¦æ³¨æ„çš„é—®é¢˜
      #### ä¸¥é‡é—®é¢˜ (å¿…é¡»ä¿®å¤)
      - **[æ–‡ä»¶:è¡Œå·]** é—®é¢˜æè¿°
        - åŸå› åˆ†æ
        - ä¿®æ”¹å»ºè®®

      #### å»ºè®®ä¼˜åŒ– (å¯é€‰)
      - **[æ–‡ä»¶:è¡Œå·]** é—®é¢˜æè¿°
        - ä¼˜åŒ–å»ºè®®

      ### ğŸ”’ å®‰å…¨æ£€æŸ¥
      - SQL æ³¨å…¥é£é™©æ£€æŸ¥
      - XSS è·¨ç«™è„šæœ¬æ£€æŸ¥
      - æ•æ„Ÿä¿¡æ¯æ³„éœ²æ£€æŸ¥
      - æƒé™æ§åˆ¶æ£€æŸ¥
      - å…¶ä»–å®‰å…¨é—®é¢˜

      ### âš¡ æ€§èƒ½å»ºè®®
      - ï¼ˆå¦‚æœ‰æ€§èƒ½é—®é¢˜æˆ–ä¼˜åŒ–å»ºè®®ï¼‰

      ### ğŸ“ ä»£ç è§„èŒƒ
      - ï¼ˆå‘½åè§„èŒƒã€æ³¨é‡Šã€æ ¼å¼ç­‰ï¼‰

      ## ğŸ’¡ æ€»ä½“å»ºè®®
      ï¼ˆæ€»ç»“æ€§çš„å»ºè®®å’Œæ”¹è¿›æ–¹å‘ï¼‰

      ---
      **ä»£ç å˜æ›´å†…å®¹ï¼š**
      ```diff
      {diff}
      ```