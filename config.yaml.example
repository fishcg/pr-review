# PR Review Service Configuration

# AI Service URL (required)
# 填写你的 AI 服务地址
ai_api_url: "http://127.0.0.1:3128/chat/completions"

# AI API Key (required for AI service authentication)
# 填写你的 AI API Key
ai_api_key: "sk-xxxxxxxxxxxxxxxxxxxxx"

# AI Model name (default: qwen-plus-latest)
ai_model: "qwen-plus-latest"

# Service port (default: 7995)
port: "7995"

# ===== VCS Provider Configuration =====
# VCS Provider: "github" or "gitlab" (default: github)
# 选择版本控制系统: github 或 gitlab
vcs_provider: "github"


# Review 模式: "api" 或 "claude_cli"
# - api: 使用传统的 AI API 审查（只传入 diff）
# - claude_cli: 使用 Claude CLI 深度审查（克隆仓库，理解项目上下文）
review_mode: "claude_cli"

# Claude CLI 配置（仅在 review_mode 为 claude_cli 时使用）
claude_cli:
  binary_path: "claude"  # Claude CLI 可执行文件路径（默认从 PATH 查找）
  allowed_tools:         # 允许 Claude CLI 使用的工具
    - "Read"
    - "Glob"
    - "Grep"
    - "Bash"
  timeout: 600           # Claude CLI 执行超时（秒），默认 10 分钟
  max_output_length: 100000  # 最大输出长度（字节）

# 仓库克隆配置（仅在 review_mode 为 claude_cli 时使用）
repo_clone:
  temp_dir: "/tmp/pr-review-repos"  # 临时目录，用于存放克隆的仓库
  clone_timeout: 180                # 克隆超时（秒），默认 3 分钟
  shallow_clone: true               # 是否使用浅克隆（节省时间和空间）
  shallow_depth: 100                # 浅克隆深度
  cleanup_after_review: true        # Review 后是否立即清理工作目录

# ===== GitHub Configuration =====
# GitHub Personal Access Token (required when vcs_provider=github)
# Needs permissions: repo (for private repos) or public_repo (for public repos)
# 创建 GitHub Token: https://github.com/settings/tokens
github_token: "ghp_xxxxxxxxxxxxxxxxxxxxx"

# GitHub Webhook Secret (optional, but recommended for security)
# 用于验证 webhook 请求的签名，建议使用随机字符串
# 如果不填写，则不验证签名（不安全）
webhook_secret: ""

# ===== GitLab Configuration =====
# GitLab Personal Access Token (required when vcs_provider=gitlab)
# Needs scopes: api, read_api, write_repository
# 创建 GitLab Token: https://gitlab.com/-/profile/personal_access_tokens
gitlab_token: "glpat-xxxxxxxxxxxxxxxxxxxxx"

# GitLab Instance URL (default: https://gitlab.com)
# 私有部署填写完整地址，如: https://gitlab.company.com
# 公网版本可以留空或填写 https://gitlab.com
gitlab_base_url: ""

# GitLab Webhook Token (optional, but recommended for security)
# 用于验证 webhook 请求的 token
gitlab_webhook_token: ""

# ===== Review Settings =====
# Inline issue comments mode (default: false)
# 开启后，问题会拆分成行内评论，PR 大评论只保留评分/修改点/总结
inline_issue_comment: true

# Comment only on changed lines (default: false)
# 开启后，只对修改的代码行（+/-）发布评论，未修改的上下文行的问题会被完全忽略
# - true: 上下文行的问题不会出现在行内评论，也不会出现在 PR/MR 主评论中
# - false (GitHub): 可以对上下文行发布行内评论
# - false (GitLab): 上下文行无法发布行内评论（API 限制），但会在 PR 主评论中列出
comment_only_changes: true

# Line match strategy (default: snippet_first)
# 行号匹配策略，用于将 AI 返回的问题定位到 diff 中的具体行
# - snippet_first: 优先使用代码片段匹配，然后才使用行号（推荐，更准确）
# - line_number_first: 优先使用 AI 提供的行号，代码片段作为备选
# 说明：snippet_first 更可靠，即使 AI 行号计算错误，也能通过代码片段准确定位
line_match_strategy: snippet_first

# AI Review Prompts
# System prompt - defines the AI's role and behavior
system_prompt: |
  你是一个专业的代码审查助手。
  审查重点：Bug、安全漏洞、性能问题、代码规范。
  保持简洁、客观、建设性，用中文回复。
  Code Review 要点：
  1. **逻辑错误与 Bug**：是否存在潜在的逻辑漏洞、边界条件处理不当或空指针风险？
  2. **代码质量与可读性**：是否遵循 Clean Code 原则？变量命名是否清晰？函数是否过长？是否有冗余代码？
  3. **性能优化**：是否存在不必要的循环、内存泄露或可以优化的算法复杂度？
  4. **安全性**：是否存在常见的安全漏洞（如 SQL 注入、XSS、敏感信息泄露、不安全的加密等）？
  5. **可测试性**：代码是否易于编写单元测试？是否实现了关注点分离？
  6. **最佳实践**：是否符合该编程语言/框架的主流社区最佳实践？
  7. **文档与注释**：是否有必要的注释和文档？注释是否准确反映代码意图？
  8. 如果代码中有写得棒的地方，也请顺带表扬。

# User prompt template - the actual review request
# Use {diff} as placeholder for the code diff
user_prompt_template: |
  审查以下代码变更（unified diff 格式），用 markdown 格式输出。

  **重要：如何正确识别行号**

  Unified diff 格式说明：
  - 以 `@@` 开头的行称为 hunk header，格式：`@@ -旧起始行,旧行数 +新起始行,新行数 @@`
    例如：`@@ -1,10 +1,11 @@` 表示旧文件从第1行开始共10行，新文件从第1行开始共11行

  - 每行的前缀含义：
    - ` `（空格）：未修改的上下文行（同时存在于新旧文件）
    - `+`：新增的行（只存在于新文件）
    - `-`：删除的行（只存在于旧文件）

  **行号计算规则（关键！）**：
  1. 从 hunk header 中获取起始行号（例如 `@@ -1,10 +1,11 @@` 中，旧文件起始行=1，新文件起始行=1）
  2. 逐行处理：
     - 遇到 ` `（上下文行）：旧行号+1，新行号+1
     - 遇到 `+`（新增行）：只有新行号+1，旧行号不变
     - 遇到 `-`（删除行）：只有旧行号+1，新行号不变

  **示例（务必理解）**：
  ```diff
  @@ -1,5 +1,6 @@
   line 1           # 上下文行：旧行号=1, 新行号=1
   line 2           # 上下文行：旧行号=2, 新行号=2
  -old line 3       # 删除行：旧行号=3, 新行号=无（填"-"）
  +new line A       # 新增行：旧行号=无（填"-"）, 新行号=3
  +new line B       # 新增行：旧行号=无（填"-"）, 新行号=4
   line 4           # 上下文行：旧行号=4, 新行号=5
  ```

  **问题表格填写规范**：
  | 列名 | 填写规则 |
  |------|---------|
  | 文件名 | 完整的文件路径（从 diff 的 `+++ b/` 行提取） |
  | 旧行号 | 新增行填 `-`；删除/修改行填按上述规则计算的旧文件行号 |
  | 新行号 | 删除行填 `-`；新增/修改行填按上述规则计算的新文件行号 |
  | 代码片段 | **必须**是 diff 中某一行的原文（去掉前缀 +/-/ ），不允许省略号或多行内容 |
  | 严重程度 | 高/中/低 |
  | 类别 | bug/lint/enhance |
  | 问题描述 | 简洁描述问题 |
  | 建议修改 | 简洁的修改建议 |

  **代码片段要求（非常重要）**：
  - 必须从 diff 中复制完整的一行代码（去掉行首的 +/-/ 前缀）
  - 不要添加省略号（...）或截断代码
  - 代码片段用于精确定位，必须与 diff 中完全一致
  - 如果代码行过长，也要完整复制

  给出简洁的反馈如下（注意括号内容为说明，不要输出）：

  ### 评分: X
  （满分 100，严重bug<60，有语法错误=0，轻微问题扣5-10分）

  ### 修改点:
  - xxxx
  - xxxx

  ### 问题:
  | 文件名 | 旧行号 | 新行号 | 代码片段 | 严重程度 | 类别 | 问题描述 | 建议修改 |
  |--------|--------|--------|----------|----------|------|----------|----------|

  ### 总结: 一句话评价，是否建议合入（建议合入时打✅标记，否则打❌）

  ---
  代码变更:
  ```diff
  {diff}
  ```
